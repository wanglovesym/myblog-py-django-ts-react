# ============================================================
# Nginx 反向代理配置（生产）
# 职责：
# 1) 接收所有外部请求（80端口）
# 2) 将 /api/* 路由转发给后端（Gunicorn）
# 3) 除 /api 外的路由交给前端静态（SPA）
# 4) 统一设置基础安全头（后续可增强）
# ============================================================

###############################################################################
# Nginx 反向代理配置（HTTPS 生产版本 + HSTS + 安全头）
# -----------------------------------------------------------------------------
# 场景：证书已签发，可启用 443 与强制重定向；仍保留 ACME 路径用于后续自动续期。
# 设计目标：
#   1. 所有普通请求经 80 → 301 到 HTTPS（除 ACME 验证路径）。
#   2. 在 443 上提供 API、Admin、前端 SPA、静态文件加速。
#   3. 加入关键安全响应头（HSTS / CSP / X-Frame-Options / 等）。
#   4. 支持 gzip 压缩与合理缓存策略（可按需扩展）。
#   5. 证书续期无需改动配置（webroot 仍指向 /var/www/certbot）。
#
# 自动续期说明：certbot 已安装系统定时任务；可用 `certbot renew --dry-run` 验证。
# CSP 可根据前端真实需要调整（本示例较为保守，允许 inline 样式用于 Tailwind JIT）。
#
# 常见运维排错提示：
#   - 若浏览器提示证书过期：检查 `ls -l /etc/letsencrypt/live/<domain>` 与日志 `/var/log/letsencrypt/letsencrypt.log`。
#   - 若 ACME 续期失败：`curl -I http://<domain>/.well-known/acme-challenge/test.txt` 验证 200。
#   - 若前端路由 404：需在前端容器内提供 index.html 并考虑 `try_files`。这里简单代理。
###############################################################################

# -------------------- Worker 基础配置 --------------------
user  nginx;                # 运行 Nginx 的系统用户（alpine 镜像内存在）
worker_processes  auto;     # 自动根据 CPU 核心数调整工作进程数量

events {
    worker_connections  1024;  # 每个 worker 允许的最大并发连接数（可按并发场景调优）
}

http {
    # ---------------- Gzip 压缩（文本类资源提升传输效率） ----------------
    gzip on;                    # 启用 gzip
    gzip_comp_level 6;          # 压缩等级（1-9，兼顾 CPU 与收益）
    gzip_min_length 512;        # 小于该大小的响应不压缩
    gzip_vary on;               # 添加 Vary: Accept-Encoding 便于代理缓存区分
    gzip_proxied any;           # 允许代理后的压缩
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss image/svg+xml;
    # -------- MIME 类型与传输优化 --------
    include       /etc/nginx/mime.types;   # 为常见扩展名映射正确的 Content-Type
    default_type  application/octet-stream;# 未识别类型的默认值，避免纯文本误判
    sendfile        on;                    # 启用零拷贝发送文件，提高静态文件效率
    tcp_nopush      on;                    # 优化报文头发送，减少网络包碎片
    tcp_nodelay     on;                    # 及时发送小数据包，降低交互延迟
    keepalive_timeout  65;                 # HTTP keep-alive 链接保持时长（秒）

    # -------- 日志配置 --------
    access_log  /var/log/nginx/access.log; # 访问日志（可接入集中日志系统）
    error_log   /var/log/nginx/error.log warn; # 错误日志（warn 级别以上记录）

    # -------- 上游服务定义 --------
    upstream backend_upstream {
        # 后端 Gunicorn 容器内部监听端口
        server backend:8000;
    }
    upstream frontend_upstream {
        # 前端静态页面容器内部监听端口
        server frontend:80;
    }

    # =====================================================================
    # HTTP(80) 入口：仅保留 ACME，其他全部重定向到 HTTPS
    # =====================================================================
    server {
        listen 80;
        server_name api.wangshixin.me;

        # ACME 验证保持 200，不做重定向；续期依赖此路径。
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # 其他所有请求永久重定向到 HTTPS（301）
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # =====================================================================
    # HTTPS(443) 主服务：API / Admin / 前端 / 静态文件
    # =====================================================================
    server {
        listen 443 ssl;          # 按新语法去掉 listen 参数中的 http2
        http2 on;                # 单独启用 HTTP/2，避免弃用警告
        server_name api.wangshixin.me;

        # ---------------- TLS 证书配置 ----------------
        ssl_certificate     /etc/letsencrypt/live/api.wangshixin.me/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/api.wangshixin.me/privkey.pem;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        # 可选：开启 OCSP Stapling（需上游支持）
        # ssl_stapling on;
        # ssl_stapling_verify on;

        # ---------------- 安全响应头 ----------------
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header Referrer-Policy strict-origin-when-cross-origin always;
        add_header X-XSS-Protection "1; mode=block" always;
        # 基础 CSP：仅允许自身域名资源；若前端需要外部资源请在后续迭代再添加。
        add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self'; font-src 'self';" always;

        # ---------------- 静态文件（Django collectstatic） ----------------
        location /static/ {
            alias /var/www/myblog/static/;
            expires 7d;
            add_header Cache-Control "public";
        }

        # ---------------- API 代理 ----------------
        location /api/ {
            proxy_pass http://backend_upstream;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Host $host; # 供 Django USE_X_FORWARDED_HOST 使用，确保域名匹配 Referer
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------------- Admin 后台代理 ----------------
        location /admin/ {
            proxy_pass http://backend_upstream;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Host $host; # 同步转发外部访问域名
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------------- 非 API/Admin/Static 的根路径处理 ----------------
        # 不在 api 子域直接提供前端 SPA，保持职责单一；可选择：
        # 方式A：直接 404 （提高歧义明显性）
        # 方式B：302 临时重定向到主站 www（SEO 友好但会被频繁访问）
        # 这里采用 301 永久重定向，方便浏览器与搜索引擎缓存。
        location / {
            return 301 https://www.wangshixin.me$request_uri;
        }
    }
}

# ---------------- 维护与扩展指南 ----------------
# 1) 添加速率限制示例：
#    limit_req_zone $binary_remote_addr zone=api_rate:10m rate=30r/m;
#    location /api/ { limit_req zone=api_rate burst=10 nodelay; ... }
# 2) 若前端需要路由降级到 index.html：
#    location / { try_files $uri $uri/ /index.html; }
# 3) 调整 CSP 时务必同步测试前端功能（图标 / 字体 / 第三方脚本）。
# 4) 若需要 WebSocket：在对应 location 增加
#    proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade";
# 5) gzip 针对图片无效（图片已有格式压缩），可结合 CDN 提升性能。