# ============================================================
# Nginx 反向代理配置（生产）
# 职责：
# 1) 接收所有外部请求（80端口）
# 2) 将 /api/* 路由转发给后端（Gunicorn）
# 3) 除 /api 外的路由交给前端静态（SPA）
# 4) 统一设置基础安全头（后续可增强）
# ============================================================

user  nginx;
worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    # 基础优化
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;

    # 设置日志（可用 Docker 日志驱动收集）
    access_log  /var/log/nginx/access.log;
    error_log   /var/log/nginx/error.log warn;

    # 上游服务定义（容器名用 Compose 的服务名）
    upstream backend_upstream {
        server backend:8000;  # 后端服务：Gunicorn 在容器内部监听 8000
    }
    upstream frontend_upstream {
        server frontend:80;   # 前端静态：Nginx 在容器内部监听 80
    }

    # 默认服务器（HTTP）
    server {
        listen 80;
        server_name _;        # 接收所有域名（可设置你的域名）

        # 安全基础头（可根据需要调整）
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header Referrer-Policy strict-origin-when-cross-origin;

        # ========== API 路由 ==========
        location /api/ {
            proxy_pass http://backend_upstream;   # 转发到后端
            proxy_http_version 1.1;
            proxy_set_header Host $host;          # 保留原始 Host 头
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ========== 静态前端（SPA） ==========
        location / {
            proxy_pass http://frontend_upstream;  # 转发到前端静态资源
            # SPA 路由兜底：确保 /post/xxx 等前端路由可直接访问
            # 若前端静态容器已正确配置 index.html fallback，则可省略
            # 如需直接由 proxy 提供静态，也可改为 root + try_files
        }

        # 可选：直接在 proxy 层提供缓存策略（如图片/CSS/JS）
        # location ~* \.(?:css|js|jpg|jpeg|png|gif|ico|svg)$ {
        #     expires 7d;
        #     add_header Cache-Control "public, immutable";
        #     proxy_pass http://frontend_upstream;
        # }
    }

    # ========== 将来开启 HTTPS 的占位 ==========
    # server {
    #     listen 443 ssl http2;
    #     server_name your-domain.com;
    #
    #     ssl_certificate     /etc/nginx/certs/fullchain.pem;
    #     ssl_certificate_key /etc/nginx/certs/privkey.pem;
    #
    #     # 其余配置与上面 server 相同（建议抽成片段 include）
    # }
}